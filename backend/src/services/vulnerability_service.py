from typing import Dict, Any, List, Optional

from backend.src.integrations.targets.code_client import CodeClient
from backend.src.integrations.security.scanners import security_scanner


class VulnerabilityService:
    """
    High-level service to generate vulnerability reports
    for a given project/codebase.
    """

    async def scan_project(
        self,
        repo_path: str,
        extra_deps: Optional[List[Dict[str, str]]] = None,
        semgrep_ruleset: str = "p/ci",
    ) -> Dict[str, Any]:
        """
        Full vulnerability analysis:
        - Extract dependencies from repo (requirements.txt, package.json)
        - Merge with extra_deps (if provided)
        - Run OSV + NVD dependency scans
        - Run Semgrep static analysis on code
        """

        code_client = CodeClient(repo_path)
        deps = code_client.extract_dependencies()

        if extra_deps:
            deps.extend(extra_deps)

        report = await security_scanner.full_vulnerability_report(
            deps=deps,
            code_path=repo_path,
            semgrep_ruleset=semgrep_ruleset,
        )

        return {
            "dependencies": deps,
            "dependency_vulns": report["dependency_vulns"],
            "code_vulns": report["code_vulns"],
            "stats": report["stats"],
        }


vulnerability_service = VulnerabilityService()
